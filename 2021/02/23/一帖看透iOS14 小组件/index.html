<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-atom.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="小组件," />





  <link rel="alternate" href="/atom.xml" title="Bruin'sBlog" type="application/atom+xml" />






<meta name="description" content="自iOS8之后，苹果支持了扩展（Extension）的开发，开发者可以通过系统提供给我们的扩展接入点 (Extension point) 来为系统特定的服务提供某些附加的功能。但iOS14后，苹果更新了扩展组件，引入了新的UI组件：WidgetKit 而舍弃了iOS14以下版本的Today Extension组件  Widget介绍这里有一份官方的小组件使用指南 简单来说：小组件相当于一个动态程">
<meta property="og:type" content="article">
<meta property="og:title" content="一帖看透iOS14 小组件">
<meta property="og:url" content="http://yoursite.com/2021/02/23/%E4%B8%80%E5%B8%96%E7%9C%8B%E9%80%8FiOS14%20%E5%B0%8F%E7%BB%84%E4%BB%B6/index.html">
<meta property="og:site_name" content="Bruin&#39;sBlog">
<meta property="og:description" content="自iOS8之后，苹果支持了扩展（Extension）的开发，开发者可以通过系统提供给我们的扩展接入点 (Extension point) 来为系统特定的服务提供某些附加的功能。但iOS14后，苹果更新了扩展组件，引入了新的UI组件：WidgetKit 而舍弃了iOS14以下版本的Today Extension组件  Widget介绍这里有一份官方的小组件使用指南 简单来说：小组件相当于一个动态程">
<meta property="og:locale">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu0x3a5faj305g05p0tr.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu0y70jk5j30ae0bgjuv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1b833goj30g90gdadn.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1b7z83jj30kb0eodh5.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1b7vu85j30ke0eoq3v.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEgy1gnu587og7mj30e902s3yi.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1ge3kbuj30eb03hglp.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu2oixw72j304o051mx9.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwiq5qmqfj30n80rugn1.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwfwkcrujj30il04f3yq.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwfux3fiej31310ibn10.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwfqmmkj4j305r06waag.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwg0oh85cj30iw06ljsr.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwgzuiadlj30rh09g751.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnwha6k9wsj30970g3dgy.jpg">
<meta property="article:published_time" content="2021-02-22T16:00:00.000Z">
<meta property="article:modified_time" content="2022-07-12T06:44:55.016Z">
<meta property="article:author" content="zcx">
<meta property="article:tag" content="小组件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnu0x3a5faj305g05p0tr.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/02/23/一帖看透iOS14 小组件/"/>





  <title>一帖看透iOS14 小组件 | Bruin'sBlog</title>
  








<meta name="generator" content="Hexo 6.2.0"></head>
  
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Bruin'sBlog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/23/%E4%B8%80%E5%B8%96%E7%9C%8B%E9%80%8FiOS14%20%E5%B0%8F%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bruin'sBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">一帖看透iOS14 小组件</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-23T00:00:00+08:00">
                2021-02-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2021/02/23/%E4%B8%80%E5%B8%96%E7%9C%8B%E9%80%8FiOS14%20%E5%B0%8F%E7%BB%84%E4%BB%B6/" class="leancloud_visitors" data-flag-title="一帖看透iOS14 小组件">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>自iOS8之后，苹果支持了扩展（Extension）的开发，开发者可以通过系统提供给我们的扩展接入点 (Extension point) 来为系统特定的服务提供某些附加的功能。<br>但iOS14后，苹果更新了扩展组件，引入了新的UI组件：<code>WidgetKit</code> 而舍弃了iOS14以下版本的Today Extension组件</p>
</blockquote>
<h3 id="Widget介绍"><a href="#Widget介绍" class="headerlink" title="Widget介绍"></a>Widget介绍</h3><p><a target="_blank" rel="noopener" href="https://support.apple.com/zh-cn/HT207122">这里有一份官方的小组件使用指南</a></p>
<p>简单来说：小组件相当于一个动态程序入口，在有限的空间内展示你想看到的重要的信息</p>
<span id="more"></span>

<img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu0x3a5faj305g05p0tr.jpg" alt="日历小组件" style="zoom:70%;" />

<p>苹果自带的日历使用起来非常不适，下载第三方日历又不想被捆绑的无用功能打扰。有了小组件之后这个问题就很好的解决了，比如上面的日历小组件，清晰的展示了今天的日期和农历以及周几，打开手机锁屏就能看见。</p>
<p>此外系统自带的电量小组件，方便的展示了需要下滑去状态栏才能看到的耳机电量：</p>
<img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu0y70jk5j30ae0bgjuv.jpg" alt="电池小组件" style="zoom:50%;" />

<p>之前发布的时候觉得这都是安卓系统玩剩下的东西，没什么卵用，不过现在是真香！</p>
<hr>
<h3 id="Widget设计指南"><a href="#Widget设计指南" class="headerlink" title="Widget设计指南"></a>Widget设计指南</h3><p><a target="_blank" rel="noopener" href="https://developer.apple.com/design/human-interface-guidelines/ios/system-capabilities/widgets/">这里有一份官方的设计指南</a></p>
<p>简而言之，设计一个简单漂亮吸引人并且快速显示内容的小组件。</p>
<hr>
<h3 id="Widget-HelloWorld"><a href="#Widget-HelloWorld" class="headerlink" title="Widget: HelloWorld"></a>Widget: HelloWorld</h3><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/widgetkit/creating-a-widget-extension">这里有一份官方的开发文档可以参考</a></p>
<p>一个小组件需要经过</p>
<p><code>FIle</code> &gt; <code>New</code> &gt;<code>Target</code> &gt;<code>Wiget Extension</code>  来创建</p>
<img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1b833goj30g90gdadn.jpg" style="zoom:100%;" />

<p>找到我们需要的<code>Widget Extension</code></p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1b7z83jj30kb0eodh5.jpg"></p>
<p>命名小组件</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1b7vu85j30ke0eoq3v.jpg"></p>
<p>图中圈着的选项控制了我们的小组件能否配置属性，例如天气相关的小组件就可能需要你手动配置地址来获取你想要知道的城市的天气数据。</p>
<p>这样就创建好了一个小组件。小组件的文件结构如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnu587og7mj30e902s3yi.jpg" alt="不带配置项的小组件结构"></p>
<p>这里我们选则了不带配置项的小组件</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu1ge3kbuj30eb03hglp.jpg" alt="带配置项的结构"></p>
<p>带配置项的小组件的结构 主要区别在于 <code>TestWidget.intentdefinition</code>文件上，这个文件内部可以添加配置选项。</p>
<p>TestWidget代码如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> WidgetKit</span><br><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Provider</span>: <span class="title class_">TimelineProvider</span> &#123;</span><br><span class="line">   	<span class="comment">/// 默认显示（无自定数据情况下显示）</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">placeholder</span>(<span class="params">in</span> <span class="params">context</span>: <span class="type">Context</span>) -&gt; <span class="type">SimpleEntry</span> &#123;</span><br><span class="line">        <span class="type">SimpleEntry</span>(date: <span class="type">Date</span>())</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">///getSnapshot方法是提供一个预览数据，可以让用户看到该组件的一个大致情况，是长什么样、显示什么数据的，可以写成固定数据，国外的			文章里叫它“fake information”</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">getSnapshot</span>(<span class="params">in</span> <span class="params">context</span>: <span class="type">Context</span>, <span class="params">completion</span>: <span class="keyword">@escaping</span> (<span class="type">SimpleEntry</span>) -&gt; ()) &#123;</span><br><span class="line">        <span class="keyword">let</span> entry <span class="operator">=</span> <span class="type">SimpleEntry</span>(date: <span class="type">Date</span>())</span><br><span class="line">        completion(entry)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">		<span class="comment">///包含要显示的所有条目：预期显示的时间（条目的日期）以及时间轴“过期”的时间</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">getTimeline</span>(<span class="params">in</span> <span class="params">context</span>: <span class="type">Context</span>, <span class="params">completion</span>: <span class="keyword">@escaping</span> (<span class="type">Timeline</span>&lt;<span class="type">Entry</span>&gt;) -&gt; ()) &#123;</span><br><span class="line">        <span class="keyword">var</span> entries: [<span class="type">SimpleEntry</span>] <span class="operator">=</span> []</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate a timeline consisting of five entries an hour apart, starting from the current date.</span></span><br><span class="line">        <span class="keyword">let</span> currentDate <span class="operator">=</span> <span class="type">Date</span>()</span><br><span class="line">        <span class="keyword">for</span> hourOffset <span class="keyword">in</span> <span class="number">0</span> <span class="operator">..&lt;</span> <span class="number">5</span> &#123;</span><br><span class="line">            <span class="comment">//需要在这里从网络加载数据回来 同步进行初始化</span></span><br><span class="line">            <span class="keyword">let</span> entryDate <span class="operator">=</span> <span class="type">Calendar</span>.current.date(byAdding: .hour, value: hourOffset, to: currentDate)<span class="operator">!</span></span><br><span class="line">            <span class="keyword">let</span> entry <span class="operator">=</span> <span class="type">SimpleEntry</span>(date: entryDate)</span><br><span class="line">            entries.append(entry)</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// atEnd 指在最后一个显示时间点的小组件完毕后重新刷新TimeLine</span></span><br><span class="line">        <span class="keyword">let</span> timeline <span class="operator">=</span> <span class="type">Timeline</span>(entries: entries, policy: .atEnd)</span><br><span class="line">        completion(timeline)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SimpleEntry</span>: <span class="title class_">TimelineEntry</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> date: <span class="type">Date</span></span><br><span class="line">  	<span class="comment">// 下面可以自己添加自定义的model</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TestWidgetEntryView</span> : <span class="title class_">View</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> entry: <span class="type">Provider</span>.<span class="type">Entry</span></span><br><span class="line">		<span class="comment">// swiftUI的View 可以返回一系列View 具体请参看SwiftUI文档</span></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">Text</span>(entry.date, style: .time)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 小组件主入口</span></span><br><span class="line"><span class="keyword">@main</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TestWidget</span>: <span class="title class_">Widget</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> kind: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;TestWidget&quot;</span></span><br><span class="line">		<span class="comment">// StaticConfiguration 不带配置项的小组件初始化方式</span></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">WidgetConfiguration</span> &#123;</span><br><span class="line">        <span class="type">StaticConfiguration</span>(kind: kind, provider: <span class="type">Provider</span>()) &#123; entry <span class="keyword">in</span></span><br><span class="line">            <span class="type">TestWidgetEntryView</span>(entry: entry)</span><br><span class="line">        &#125;</span><br><span class="line">        .configurationDisplayName(<span class="string">&quot;My Widget&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;This is an example widget.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实时预览view</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TestWidget_Previews</span>: <span class="title class_">PreviewProvider</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> previews: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">TestWidgetEntryView</span>(entry: <span class="type">SimpleEntry</span>(date: <span class="type">Date</span>()))</span><br><span class="line">            .previewContext(<span class="type">WidgetPreviewContext</span>(family: .systemSmall))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>于是我们获得了第一个小组件：</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnu2oixw72j304o051mx9.jpg"></p>
<p>看起来很简单吧！</p>
<hr>
<h3 id="Widget结构解析"><a href="#Widget结构解析" class="headerlink" title="Widget结构解析"></a>Widget结构解析</h3><h4 id="至关重要-TimeLine"><a href="#至关重要-TimeLine" class="headerlink" title="至关重要 TimeLine"></a>至关重要 TimeLine</h4><p><code>getTimeLine</code> 方法获取小组件整个显示周期。</p>
<p>为了管理系统负载，<code>WidgetKit</code>使用预算来分配一天中的窗口小部件重新负载。</p>
<blockquote>
<p>Widgets use SwiftUI views to display their content. WidgetKit renders the views on your behalf in a separate process. As a result, your widget extension is not continually active, even if the widget is onscreen. Despite your widget not always being active, there are several ways you can keep its content up to date.</p>
</blockquote>
<p>抛开<code>SwiftUI</code>不谈，单说 <code>your widget extension is not continually active</code> ，这段文字清晰的说明了小组件所面临的问题：不能实时刷新。即使你的小组件在你目光注视中，小组件也不能保持最新状态。</p>
<p>重新加载窗口小部件会消耗系统资源，并会由于额外的联网和处理而导致电池消耗。为了减少对性能的影响并保持全天的电池寿命，请求的更新频率和更新次数将会限制为必要。</p>
<p>那么小组件如何刷新？</p>
<blockquote>
<p>Many widgets have predictable points in time where it makes sense to update their content. For example, a widget that displays weather information might update the temperature hourly throughout the day. A stock market widget could update its content frequently during open market hours, but not at all over the weekend. By planning these times in advance, WidgetKit automatically refreshes your widget when the appropriate time arrives.</p>
</blockquote>
<p>许多APP需要定时刷新数据，这些刷新时间是可预测的，比如日历APP每天刷新当日的日期信息，股市APP则会在工作日频繁刷新交易信息，但是在休息日不频繁刷新。</p>
<p>当我们能够为小组件提供一个可预测的时间点和刷新策略，系统便会按照既定的顺序刷新。</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwiq5qmqfj30n80rugn1.jpg"></p>
<p>如图所示，我们在<code>.Now</code>和每隔1小时共三小时设置四个显示时间点，系统在get到我们给定的<code>TimeLine</code>之后会在当前、一小时后、两小时后、三小时后总计四个时间点进行小组件UI渲染,由于我们第一次给定的重新刷新策略为<code>.atEnd</code>所以会在三个小时时间点渲染完毕之后重新获取<code>TimeLine</code>。</p>
<p>第二个<code>TimeLine(Provide timeline)</code>中设置的重新刷新策略为<code>.never</code>所以在这个时间点的小组件渲染完毕之后就不再刷新了。</p>
<h4 id="添加预览-Snapshot"><a href="#添加预览-Snapshot" class="headerlink" title="添加预览 Snapshot"></a>添加预览 Snapshot</h4><p><code>getSnapshot</code>方法比较简单，这个方法获取我们在打开小组件预览界面时所看到的三个小组件的<code>Entry</code>。</p>
<p>这里如果不需要展示实时数据的时候可以放入固定的预览数据以获得最好的体验(不需要请求网络直接渲染数据)。</p>
<h4 id="界面美化-Placeholder"><a href="#界面美化-Placeholder" class="headerlink" title="界面美化 Placeholder"></a>界面美化 Placeholder</h4><p><code>placeholder</code>方法目的在于获取一个没有数据或者没有网络情况下的默认View,一般是进行美化小组件的时候在这个view上做文章，</p>
<h4 id="数据支撑-TimelineEntry"><a href="#数据支撑-TimelineEntry" class="headerlink" title="数据支撑 TimelineEntry"></a>数据支撑 TimelineEntry</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SimpleEntry</span>: <span class="title class_">TimelineEntry</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> date: <span class="type">Date</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TimelineEntry</code>协议必须包含一个<code>date</code>属性，用于计算需要渲染页面的时间点</p>
<p>自定义的模型可以实现这个协议用于承载内容数据。</p>
<h4 id="内容基石-WidgetEntryView"><a href="#内容基石-WidgetEntryView" class="headerlink" title="内容基石 WidgetEntryView"></a>内容基石 WidgetEntryView</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TestWidgetEntryView</span> : <span class="title class_">View</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> entry: <span class="type">Provider</span>.<span class="type">Entry</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">Text</span>(entry.date, style: .time)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小组件的<code>View</code>就是一个普通的包含<code>Provider.Entry</code>的<code>View(swiftUI)</code>，一般创建timeline的时候会提供<code>Provider.Entry</code>给<code>View</code>进行渲染。</p>
<p><code>body</code>属性下包含一系列<code>VIew</code>控件用于渲染页面，更多<code>SwiftUI</code>相关的知识看<a target="_blank" rel="noopener" href="https://developer.apple.com/tutorials/swiftui/creating-and-combining-views">SwiftUI文档</a>。</p>
<p>以上就是小组件的结构拆分和解析，只要明白组成结构和运行机制就能根据自己的需求去定制开发了。</p>
<hr>
<h3 id="Widget进阶"><a href="#Widget进阶" class="headerlink" title="Widget进阶"></a>Widget进阶</h3><h4 id="功能和限制"><a href="#功能和限制" class="headerlink" title="功能和限制"></a>功能和限制</h4><p><code>iOS14 Widget</code>的功能对比着以前的<code>TodayExtension</code>要少了很多，官方对小组件添加了很多限制。</p>
<ul>
<li>小组件扩展整体需要使用<code>SwiftUI</code>结构，<code>WidgetEntryView</code>需要提供<code>SwiftUIView</code>。</li>
<li>页面滚动、动画和视频是被禁止的，<code>SwiftUI</code> 中<code> List</code> 控件是无法使用的，扩展的<code>UIKit</code>中 <code>UIVisualEffectView</code>是被禁用的(毛玻璃效果)，更多被禁用的<code>View</code>还需要在开发中发现。</li>
<li>只支持点击事件交互。</li>
<li>无法主动更新数据 刷新数据使用<code>Timeline</code>方式手动设置。</li>
<li>每次重置刷新轮次的间隔不能低于5分钟，低于5分钟无效 ，我们在填充<code>entries</code>时应该为其填充5分钟内需要显示的数据。不建议显示实时时间，和手机系统显示的时间可能会出现偏差。</li>
</ul>
<h4 id="小组件样式区分-supportedFamilies"><a href="#小组件样式区分-supportedFamilies" class="headerlink" title="小组件样式区分  supportedFamilies"></a>小组件样式区分  supportedFamilies</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@main</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TestWidget</span>: <span class="title class_">Widget</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> kind: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;TestWidget&quot;</span></span><br><span class="line">		<span class="comment">// StaticConfiguration 不带配置项的小组件初始化方式</span></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">WidgetConfiguration</span> &#123;</span><br><span class="line">        <span class="type">StaticConfiguration</span>(kind: kind, provider: <span class="type">Provider</span>()) &#123; entry <span class="keyword">in</span></span><br><span class="line">            <span class="type">TestWidgetEntryView</span>(entry: entry)</span><br><span class="line">        &#125;</span><br><span class="line">        .configurationDisplayName(<span class="string">&quot;My Widget&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;This is an example widget.&quot;</span>)</span><br><span class="line">        .supportedFamilies([.systemSmall])<span class="comment">// 注意这里增加了一个方法来限制小组件支持的类型 这里只支持2x2小方块</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从主入口可以看到我们定义了一个<code>TestWidget的</code>小组件，这个小组件默认支持三种样式。</p>
<p>我们常常只需要某一个小组件只支持一种样式，比如最小的方块形状的组件设计的时候由于尺寸及形状往往不考虑其他显示格式。</p>
<p>这时我们可以在<code>StaticConfiguration</code>后跟上配置支持的样式方法<code>supportedFamilies()</code>，小组件按照体积大小分为   <code>systemSmall</code>, <code> systemMedium</code>，<code>systemLarge</code>三种。 </p>
<h4 id="多小组件容器-WidgetBundle"><a href="#多小组件容器-WidgetBundle" class="headerlink" title="多小组件容器  WidgetBundle"></a>多小组件容器  WidgetBundle</h4><p>在设计完成并确定要展示的小组件之后，我们会遇到一个问题，如何在入口方法处展示多个不同类型的小组件。</p>
<p>比如我们确定了三个小组件，<code>2x2</code>、<code>2x4</code>、<code>4x4</code>三种尺寸各一个，展示的内容也不相同。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@main</span> <span class="comment">// 移除原来的标记 放在这里 main只能存在一个</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">KrWidget</span>: <span class="title class_">WidgetBundle</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">Widget</span> &#123;</span><br><span class="line">        <span class="type">KrSmallWidget</span>()</span><br><span class="line">        <span class="type">KrMediumWidget</span>()</span><br><span class="line">        <span class="type">KrLargeWidget</span>()</span><br><span class="line">      	<span class="type">TestWidget</span>()<span class="comment">// 声明好的小组件可以在WidgetBundle下直接初始化</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时我们可以将入口方法标记改成<code>WidgetBundle</code>来适应多个小组件，<code>KrSmallWidget</code>、<code>KrMediumWidget</code>、<code>KrLargeWidget</code>为我们自定义的小组件，其结构和<code>TestWidget</code>一致。</p>
<h4 id="所见即所得-PreviewProvider"><a href="#所见即所得-PreviewProvider" class="headerlink" title="所见即所得   PreviewProvider"></a>所见即所得   PreviewProvider</h4><p>如果对<code>swiftUI</code>比较熟悉的胖友对这个会比较熟悉。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TestWidget_Previews</span>: <span class="title class_">PreviewProvider</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> previews: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">        <span class="type">TestWidgetEntryView</span>(entry: <span class="type">SimpleEntry</span>(date: <span class="type">Date</span>()))</span><br><span class="line">            .previewContext(<span class="type">WidgetPreviewContext</span>(family: .systemSmall))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>PreviewProvider</code>可以呼出实时预览的页面，方便我们码UI。</p>
<p>可以点编辑器右边的resume按钮进行预览</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwfwkcrujj30il04f3yq.jpg"></p>
<p>经过build可以看到预览的结果，在你代码改动的时候会实时变化，十分方便。</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwfux3fiej31310ibn10.jpg"></p>
<p>不小心把页面关掉的话可以在右上角五条横线按钮中找到<code>Canvas</code>选项勾选即可<code>(Xcode12)</code></p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwfqmmkj4j305r06waag.jpg"></p>
<h4 id="APP内刷新小组件-WidgetCenter"><a href="#APP内刷新小组件-WidgetCenter" class="headerlink" title="APP内刷新小组件   WidgetCenter"></a>APP内刷新小组件   WidgetCenter</h4><p>如果你需要在主工程里干预小组件的刷新，你可以使用<code>WidgetCenter（单例）</code>类来进行操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Reloads the timelines for all widgets of a particular kind.</span></span><br><span class="line"> <span class="comment">/// - Parameter kind: A string that identifies the widget and matches the</span></span><br><span class="line"> <span class="comment">///   value you used when you created the widget&#x27;s configuration.</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">reloadTimelines</span>(<span class="params">ofKind</span> <span class="params">kind</span>: <span class="type">String</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment">/// Reloads the timelines for all configured widgets belonging to the</span></span><br><span class="line"> <span class="comment">/// containing app.</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">reloadAllTimelines</span>()</span><br></pre></td></tr></table></figure>

<p>一般使用这两个方法，来实现主APP内刷新小组件。</p>
<h4 id="为小组件启用定位"><a href="#为小组件启用定位" class="headerlink" title="为小组件启用定位"></a>为小组件启用定位</h4><p>一些天气类型的小组件经常会获取当前的定位，小组件中如果要请求定位信息，需要在小组件目录下的<code>info.plist</code>文件中添加<code>NSWidgetWantsLocation</code>字段来请求权限</p>
<p>更多定位权限相关的信息请参考<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/widgetkit/accessing-location-information-in-widgets">给你的小组件添加定位信息</a></p>
<h4 id="和主APP数据共享"><a href="#和主APP数据共享" class="headerlink" title="和主APP数据共享"></a>和主APP数据共享</h4><p>由于widget跟APP间相互独立，如果想用相同的数据则需要两者间数据共享，创建**<code>App Group</code>**<br>主APP中  <code>Target</code> -&gt; <code>Signing &amp; Capability</code> -&gt; <code>+Capability</code> -&gt; <code>添加 App Group</code></p>
<p>不过如果开发者账号开启<code>Automatically manage signing</code>的话苹果会自动给你创建相关联的APPID。</p>
<p>两者间的数据共享主要通过**<code>UserDefaults</code><strong>和</strong><code>FileManager</code>**两种形式。</p>
<h4 id="点击交互和跳转方式"><a href="#点击交互和跳转方式" class="headerlink" title="点击交互和跳转方式"></a>点击交互和跳转方式</h4><p>点击Widget窗口唤起APP进行交互指定跳转支持两种方式：</p>
<ul>
<li><code>.widgetURL</code>：点击区域是Widget的所有区域，适合元素、逻辑简单的小部件，一个小组件只能响应一个<code>widgetURL</code>，其中**<code>systemSmall</code>**类型的小组件只能使用此方式进行跳转</li>
<li><code>Link</code>：通过Link修饰，允许让界面上不同元素产生点击响应，一个小组件可以包含多个<code>Link</code></li>
</ul>
<p>以上两种小组件链接点击后，可以在主<code>APP</code>中的<code>APPDelegate</code>类中进行响应</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">application</span>(<span class="keyword">_</span> <span class="params">app</span>: <span class="type">UIApplication</span>, <span class="params">open</span> <span class="params">url</span>: <span class="type">URL</span>, <span class="params">options</span>: [<span class="type">UIApplication</span>.<span class="params">OpenURLOptionsKey</span> : <span class="keyword">Any</span>] <span class="operator">=</span> [:]) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">  		 <span class="comment">// 一般为小组件链接定义特殊的host进行区分</span></span><br><span class="line">       <span class="keyword">if</span> url.host <span class="operator">==</span> <span class="type">WidgetExtensionHost</span> &#123;</span><br><span class="line">         <span class="comment">//处理小组件点击事件源</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>APP</code>内做了切屏适配，实现了<code>SceneDelegate</code>则需要在<code>SceneDelegate</code>里面实现跳转处理</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">scene</span>(<span class="keyword">_</span> <span class="params">scene</span>: <span class="type">UIScene</span>, <span class="params">openURLContexts</span> <span class="params">URLContexts</span>: <span class="type">Set</span>&lt;<span class="type">UIOpenURLContext</span>&gt;) &#123;</span><br><span class="line">    <span class="keyword">for</span> context <span class="keyword">in</span> <span class="type">URLContexts</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(context.url)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调试小组件"><a href="#调试小组件" class="headerlink" title="调试小组件"></a>调试小组件</h4><p>开发的过程中总是充满了不确定性，一些东西需要断点进行调试。那么针对小组件如何调试？其实很简单，安装APP之后把<code>Scheme</code>修改为我们的<code>WidgetExtension</code>，选择测试机，然后运行，在手机上添加小组件后即可看到代码进入断点。</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwg0oh85cj30iw06ljsr.jpg"></p>
<h4 id="机型适配"><a href="#机型适配" class="headerlink" title="机型适配"></a>机型适配</h4><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwgzuiadlj30rh09g751.jpg"></p>
<p>不同的设备尺寸所拥有的小组件的尺寸也是不同的，目前（iPhone12时代）小组件有以上几种尺寸。</p>
<p>在设计界面的时候和布局时需要考虑不同大小的区域的布局区别。</p>
<p>官方建议保证大的组件看起来比较好，其他尺寸的小组件根据大尺寸的进行微调。（毕竟屏幕一天比一天大）</p>
<h4 id="暗黑模式"><a href="#暗黑模式" class="headerlink" title="暗黑模式"></a>暗黑模式</h4><p>开发过程中有遇到使用双模式的图片素材时，手机切换暗黑模式后页面的图标配图没有及时更新。总觉的目前小组件还有许多问题，不是很完善。</p>
<p>解决方案为使用单模式的图，使用两套图进行根据环境切换。</p>
<p>swiftUI中使用ColorScheme判断暗黑模式</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Environment</span>(\.colorScheme) <span class="keyword">var</span> colorScheme: <span class="type">ColorScheme</span></span><br><span class="line"><span class="comment">//根据不同模式填充不同颜色</span></span><br><span class="line"><span class="type">Rectangle</span>().fill(<span class="type">Color</span>(colorScheme <span class="operator">==</span> .dark <span class="operator">?</span> <span class="type">UIColor</span>(hex: <span class="number">0x262626</span>) <span class="operator">??</span> <span class="type">UIColor</span>.black : .white))</span><br></pre></td></tr></table></figure>

<h4 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h4><p>如果主项目是使用swift进行开发的，可以将对应的网络请求库分享到小组件的target进行使用。在对应的类文件的Target Membership选项勾选小组件target即可。</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnwha6k9wsj30970g3dgy.jpg"></p>
<p>但是一般主项目中的网络框架往往会夹杂很多定制化的插件或其他需求，这么分享会使项目工程代码依赖十分混乱。</p>
<p>小组件中要使用的接口服务不会很多，所以我建议这里使用简单的网络请求即可。</p>
<p>当然由于widget类似于todayExtension，这里可以和todayExtension的网络请求策略保持一致。</p>
<h4 id="网络图片"><a href="#网络图片" class="headerlink" title="网络图片"></a>网络图片</h4><p>SwiftUI中的Image没有提供直接加载URL方式的图片显示。在<code>getTimeline</code>中进行数据请求中<code>completion(timeline)</code>执行完之后，不再支持图片的异步回调，用异步加载的方式就无法加载网络图片，所以必须在数据请求回来的处理中采用<strong>同步方式</strong>，将图片的data获取，转换成UIImage，再赋值给Image展示</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">KrBaseWidgetEntity</span>: <span class="title class_">Mappable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> itemId: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> itemType: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> widgetTitle: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> widgetImageURL: <span class="type">URL</span>?</span><br><span class="line">    <span class="keyword">var</span> widgetImage: <span class="type">UIImage</span>?</span><br><span class="line">    <span class="keyword">var</span> route: <span class="type">String</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init?</span>(<span class="params">map</span>: <span class="type">Map</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">mapping</span>(<span class="params">map</span>: <span class="type">Map</span>) &#123;</span><br><span class="line">        itemId <span class="operator">&lt;-</span> map[<span class="string">&quot;itemId&quot;</span>]</span><br><span class="line">        itemType <span class="operator">&lt;-</span> map[<span class="string">&quot;itemType&quot;</span>]</span><br><span class="line">        widgetTitle <span class="operator">&lt;-</span> map[<span class="string">&quot;widgetTitle&quot;</span>]</span><br><span class="line">        widgetImageURL <span class="operator">&lt;-</span> (map[<span class="string">&quot;widgetImage&quot;</span>], <span class="type">CustomURLTransform</span>())</span><br><span class="line">        route <span class="operator">&lt;-</span> map[<span class="string">&quot;route&quot;</span>]</span><br><span class="line">      	<span class="comment">//获取到图片地址后直接同步获取图片数据转换为UIImage然后在View里面转换为Image显示</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url <span class="operator">=</span>  widgetImageURL,<span class="keyword">let</span> img <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">Data</span>(contentsOf: url) &#123;</span><br><span class="line">            widgetImage <span class="operator">=</span> <span class="type">UIImage</span>(data: img)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">id</span>: <span class="type">Int</span>, <span class="params">img</span>: <span class="type">UIImage</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.itemId <span class="operator">=</span> id</span><br><span class="line">        <span class="keyword">self</span>.itemType <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">self</span>.widgetTitle <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">self</span>.widgetImage <span class="operator">=</span> img</span><br><span class="line">        <span class="keyword">self</span>.route <span class="operator">=</span> defultRoute</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="埋点传值"><a href="#埋点传值" class="headerlink" title="埋点传值"></a>埋点传值</h4><p>小组件中埋点不宜设计过于复杂，因为小组件能够一直在操作系统界面上留存，但是主APP却不一定，需要传递埋点的时候只能在点击事件传递的URL中附带埋点值然后在APP内接收和处理的时候再提取固定的埋点字段。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//目前有一个自定义的埋点传值 类似&quot;media_event_value=click_mor_and_eve_widget&quot;</span></span><br><span class="line"><span class="keyword">let</span> routeStr <span class="operator">=</span> route <span class="operator">??</span> defultRoute</span><br><span class="line">  <span class="keyword">var</span> pathURL <span class="operator">=</span>  <span class="type">URL</span>(string: <span class="string">&quot;TestWidget://<span class="subst">\(widgetHost)</span>?<span class="subst">\(routeStr)</span>&quot;</span>)<span class="operator">!</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> trackStr <span class="operator">=</span> track &#123;</span><br><span class="line">      pathURL <span class="operator">=</span>  <span class="type">URL</span>(string: <span class="string">&quot;TestWidget://<span class="subst">\(widgetHost)</span>?<span class="subst">\(routeStr)</span>&amp;<span class="subst">\(trackStr)</span>&quot;</span>)<span class="operator">!</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Widget踩坑"><a href="#Widget踩坑" class="headerlink" title="Widget踩坑"></a>Widget踩坑</h3><h4 id="强制使用SwiftUI"><a href="#强制使用SwiftUI" class="headerlink" title="强制使用SwiftUI"></a>强制使用SwiftUI</h4><p>这次的小组件更新强制使用SwiftUI可以看到苹果的目标和态度。对这个UI库不熟的话开发起来还是有点困难，不过正好也可以通过Widget对swiftUI进行一次实战训练。</p>
<h4 id="偶现第一次添加小组件到桌面UI渲染失败-系统不调用getTimeLine"><a href="#偶现第一次添加小组件到桌面UI渲染失败-系统不调用getTimeLine" class="headerlink" title="偶现第一次添加小组件到桌面UI渲染失败(系统不调用getTimeLine)"></a>偶现第一次添加小组件到桌面UI渲染失败(系统不调用getTimeLine)</h4><p>测试过程中发现的一个问题</p>
<p>APP第一次安装，第一次添加小组件的的时候，如果不等待小组件预览渲染完成就直接点<code>添加到桌面</code>会触发初始化失败问题</p>
<p>断点调试发现这个时候操作系统不调用（有时候会等很久才调貌似是线程被阻塞了）<code>getTimeLine</code>方法，导致页面加载不成功，由于timeline获取失败，其后续的刷新时间点也没法确定，则最后全部都不能刷新。</p>
<h4 id="刷新不及时"><a href="#刷新不及时" class="headerlink" title="刷新不及时"></a>刷新不及时</h4><p>自己使用的一些其他家的小组件，例如上文提到的日历，偶尔能看到小组件上还保持着昨天的日期，这让我感觉体验很差。</p>
<p>这个新兴事物还有待优化呀。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%B0%8F%E7%BB%84%E4%BB%B6/" rel="tag"># 小组件</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/01/18/APP%E4%BB%A3%E7%90%86/" rel="next" title="APP内部代理">
                <i class="fa fa-chevron-left"></i> APP内部代理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/04/20/NSCache/" rel="prev" title="NSCache">
                NSCache <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container"></div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zcx4u" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/zcx940518" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zcx_bruin@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/6995445360/profile?topnav=1&wvr=6" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">Widget介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97"><span class="nav-number">2.</span> <span class="nav-text">Widget设计指南</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget-HelloWorld"><span class="nav-number">3.</span> <span class="nav-text">Widget: HelloWorld</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">Widget结构解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%B3%E5%85%B3%E9%87%8D%E8%A6%81-TimeLine"><span class="nav-number">4.1.</span> <span class="nav-text">至关重要 TimeLine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E9%A2%84%E8%A7%88-Snapshot"><span class="nav-number">4.2.</span> <span class="nav-text">添加预览 Snapshot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%95%8C%E9%9D%A2%E7%BE%8E%E5%8C%96-Placeholder"><span class="nav-number">4.3.</span> <span class="nav-text">界面美化 Placeholder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%94%AF%E6%92%91-TimelineEntry"><span class="nav-number">4.4.</span> <span class="nav-text">数据支撑 TimelineEntry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E5%9F%BA%E7%9F%B3-WidgetEntryView"><span class="nav-number">4.5.</span> <span class="nav-text">内容基石 WidgetEntryView</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget%E8%BF%9B%E9%98%B6"><span class="nav-number">5.</span> <span class="nav-text">Widget进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E5%92%8C%E9%99%90%E5%88%B6"><span class="nav-number">5.1.</span> <span class="nav-text">功能和限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F%E5%8C%BA%E5%88%86-supportedFamilies"><span class="nav-number">5.2.</span> <span class="nav-text">小组件样式区分  supportedFamilies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E5%B0%8F%E7%BB%84%E4%BB%B6%E5%AE%B9%E5%99%A8-WidgetBundle"><span class="nav-number">5.3.</span> <span class="nav-text">多小组件容器  WidgetBundle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%80%E8%A7%81%E5%8D%B3%E6%89%80%E5%BE%97-PreviewProvider"><span class="nav-number">5.4.</span> <span class="nav-text">所见即所得   PreviewProvider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#APP%E5%86%85%E5%88%B7%E6%96%B0%E5%B0%8F%E7%BB%84%E4%BB%B6-WidgetCenter"><span class="nav-number">5.5.</span> <span class="nav-text">APP内刷新小组件   WidgetCenter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E5%B0%8F%E7%BB%84%E4%BB%B6%E5%90%AF%E7%94%A8%E5%AE%9A%E4%BD%8D"><span class="nav-number">5.6.</span> <span class="nav-text">为小组件启用定位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%92%8C%E4%B8%BBAPP%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB"><span class="nav-number">5.7.</span> <span class="nav-text">和主APP数据共享</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%82%B9%E5%87%BB%E4%BA%A4%E4%BA%92%E5%92%8C%E8%B7%B3%E8%BD%AC%E6%96%B9%E5%BC%8F"><span class="nav-number">5.8.</span> <span class="nav-text">点击交互和跳转方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%B0%8F%E7%BB%84%E4%BB%B6"><span class="nav-number">5.9.</span> <span class="nav-text">调试小组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%BA%E5%9E%8B%E9%80%82%E9%85%8D"><span class="nav-number">5.10.</span> <span class="nav-text">机型适配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.11.</span> <span class="nav-text">暗黑模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="nav-number">5.12.</span> <span class="nav-text">网络请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%89%87"><span class="nav-number">5.13.</span> <span class="nav-text">网络图片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%8B%E7%82%B9%E4%BC%A0%E5%80%BC"><span class="nav-number">5.14.</span> <span class="nav-text">埋点传值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widget%E8%B8%A9%E5%9D%91"><span class="nav-number">6.</span> <span class="nav-text">Widget踩坑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8SwiftUI"><span class="nav-number">6.1.</span> <span class="nav-text">强制使用SwiftUI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%B6%E7%8E%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%B7%BB%E5%8A%A0%E5%B0%8F%E7%BB%84%E4%BB%B6%E5%88%B0%E6%A1%8C%E9%9D%A2UI%E6%B8%B2%E6%9F%93%E5%A4%B1%E8%B4%A5-%E7%B3%BB%E7%BB%9F%E4%B8%8D%E8%B0%83%E7%94%A8getTimeLine"><span class="nav-number">6.2.</span> <span class="nav-text">偶现第一次添加小组件到桌面UI渲染失败(系统不调用getTimeLine)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%B7%E6%96%B0%E4%B8%8D%E5%8F%8A%E6%97%B6"><span class="nav-number">6.3.</span> <span class="nav-text">刷新不及时</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zcx</span>

  
</div>


  <div class="powered-by">Action speak louder than words.</div>



  <span class="post-meta-divider"></span>





        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '1ce46427a2d389bf0f0a',
          clientSecret: 'e5c94c309da55fd7f82dfb09768a7685ce1021a1',
          repo: 'zcx4u.github.io',
          owner: 'zcx4u',
          admin: ['zcx4u'],
          id: location.pathname,
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>

  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("MUoigkFJVBIC84KJ66GDdRzg-gzGzoHsz", "7BcnpnTmmpl7LlKmrROjroPk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
